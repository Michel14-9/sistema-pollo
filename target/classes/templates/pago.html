<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luren Chicken - Pago</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Estilos propios -->
    <link th:href="@{/css/pago.css}" rel="stylesheet">
</head>

<body>
<!-- CSRF Token para Spring Security -->
<input type="hidden" id="csrfToken" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

<!--Fragment para el header-->
<div th:insert="~{/fragments/header.html :: header-nav}"></div>
<!--FIN Fragment para el header-->

<!-- CONTENIDO PRINCIPAL - PAGO -->
<main class="pago-page py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Progreso del pedido -->
                <div class="progreso-pedido mb-5">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                        <div class="text-center">
                            <div class="progreso-paso completado">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <span class="d-block mt-2 small fw-bold">Carrito</span>
                        </div>
                        <div class="progreso-linea completado"></div>
                        <div class="text-center">
                            <div class="progreso-paso activo">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <span class="d-block mt-2 small fw-bold">Pago</span>
                        </div>
                        <div class="progreso-linea"></div>
                        <div class="text-center">
                            <div class="progreso-paso">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="d-block mt-2 small fw-bold">Confirmación</span>
                        </div>
                    </div>
                </div>

                <!-- Header del pago -->
                <div class="pago-header mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <a th:href="@{/carrito}" class="btn btn-outline-secondary btn-volver">
                            <i class="fas fa-arrow-left me-2"></i>VOLVER AL CARRITO
                        </a>
                        <h2 class="pago-title mb-0">PROCESO DE PAGO</h2>
                        <div class="d-flex align-items-center text-muted">
                            <i class="fas fa-lock me-2"></i>
                            <span>Pago 100% Seguro</span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Columna izquierda - Información del pedido -->
                    <div class="col-lg-8">
                        <!-- Información de entrega -->
                        <div class="info-entrega card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-truck me-2 text-orange"></i>
                                    INFORMACIÓN DE ENTREGA
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Tipo de entrega *</label>
                                        <select class="form-select" id="tipoEntrega" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="delivery" selected>Delivery a domicilio</option>
                                            <option value="recojo">Recojo en tienda</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3" id="direccionField">
                                        <label class="form-label fw-bold">Dirección de entrega *</label>

                                        <!-- Select para direcciones guardadas -->
                                        <select class="form-select mb-2" id="selectDireccion">
                                            <option value="">Seleccionar dirección guardada...</option>
                                            <!-- Direcciones del usuario -->
                                            <option th:each="direccion : ${direcciones}"
                                                    th:value="${direccion.direccion}"
                                                    th:text="${direccion.nombre} + ' - ' + ${direccion.direccion}">
                                            </option>
                                            <option value="nueva">+ Agregar nueva dirección</option>
                                        </select>

                                        <!-- Campo para dirección manual -->
                                        <input type="text" class="form-control" id="inputDireccion"
                                               placeholder="Ingresa tu dirección completa"
                                               th:if="${direccionPredeterminada != null}"
                                               th:value="${direccionPredeterminada.direccion}"
                                               required>

                                        <small class="text-muted">Ej: Av. Principal #123, Urbanización, Referencia</small>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label class="form-label fw-bold">Instrucciones adicionales</label>
                                        <textarea class="form-control" rows="3" placeholder="Ej: Timbre blanco, dejar con portero, llamar antes de llegar..."></textarea>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Fecha de entrega *</label>
                                        <input type="date" class="form-control" id="fechaEntrega" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Hora de entrega *</label>
                                        <select class="form-select" id="horaEntrega" required>
                                            <option value="">Seleccionar hora...</option>
                                            <option value="12:00">12:00 PM</option>
                                            <option value="12:30">12:30 PM</option>
                                            <option value="13:00">1:00 PM</option>
                                            <option value="13:30">1:30 PM</option>
                                            <option value="14:00">2:00 PM</option>
                                            <option value="14:30">2:30 PM</option>
                                            <option value="15:00">3:00 PM</option>
                                            <option value="15:30">3:30 PM</option>
                                            <option value="16:00">4:00 PM</option>
                                            <option value="16:30">4:30 PM</option>
                                            <option value="17:00">5:00 PM</option>
                                            <option value="17:30">5:30 PM</option>
                                            <option value="18:00">6:00 PM</option>
                                            <option value="18:30">6:30 PM</option>
                                            <option value="19:00">7:00 PM</option>
                                            <option value="19:30">7:30 PM</option>
                                            <option value="20:00">8:00 PM</option>
                                            <option value="20:30">8:30 PM</option>
                                            <option value="21:00">9:00 PM</option>
                                            <option value="21:30">9:30 PM</option>
                                            <option value="22:00">10:00 PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información de contacto -->
                        <div class="info-contacto card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-user me-2 text-orange"></i>
                                    INFORMACIÓN DE CONTACTO
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Nombres separado -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Nombres *</label>
                                        <input type="text" class="form-control"
                                               th:value="${usuario != null ? usuario.nombres : ''}"
                                               placeholder="Tus nombres" required>
                                    </div>
                                    <!-- Apellidos separado -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Apellidos *</label>
                                        <input type="text" class="form-control"
                                               th:value="${usuario != null ? usuario.apellidos : ''}"
                                               placeholder="Tus apellidos" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Teléfono *</label>
                                        <input type="tel" class="form-control"
                                               th:value="${usuario != null ? usuario.telefono : ''}"
                                               placeholder="+51 XXX XXX XXX" required>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label class="form-label fw-bold">Correo electrónico *</label>
                                        <input type="email" class="form-control"
                                               th:value="${usuario != null ? usuario.username : ''}"
                                               placeholder="tu@email.com" required readonly>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="recibirOfertas">
                                            <label class="form-check-label text-muted" for="recibirOfertas">
                                                Quiero recibir ofertas y promociones especiales
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Métodos de pago -->
                        <div class="metodos-pago card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-credit-card me-2 text-orange"></i>
                                    MÉTODO DE PAGO
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Efectivo -->
                                <div class="metodo-item mb-3 p-3 border rounded">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="efectivo" value="efectivo" checked>
                                        <label class="form-check-label fw-bold" for="efectivo">
                                            <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                            Pago en Efectivo
                                        </label>
                                    </div>
                                    <p class="text-muted ms-4 mb-0 mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Paga cuando recibas tu pedido. Ten el monto exacto disponible.
                                    </p>
                                </div>

                                <!-- Tarjeta -->
                                <div class="metodo-item mb-3 p-3 border rounded">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="tarjeta" value="tarjeta">
                                        <label class="form-check-label fw-bold" for="tarjeta">
                                            <i class="fas fa-credit-card me-2 text-primary"></i>
                                            Tarjeta de Crédito/Débito
                                        </label>
                                    </div>
                                    <div class="tarjeta-info ms-4 mt-3" style="display: none;">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <label class="form-label fw-bold">Número de tarjeta *</label>
                                                <input type="text" class="form-control" placeholder="1234 5678 9012 3456" maxlength="19">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Fecha de vencimiento *</label>
                                                <input type="text" class="form-control" placeholder="MM/AA" maxlength="5">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">CVV *</label>
                                                <input type="text" class="form-control" placeholder="123" maxlength="3">
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label class="form-label fw-bold">Nombre en la tarjeta *</label>
                                                <input type="text" class="form-control" placeholder="Como aparece en la tarjeta">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tarjetas-icons ms-4 mt-2">
                                        <img th:src="@{/archivos/visa_PNG30.png}" alt="Visa" style="width: 40px;" class="me-2">
                                        <img th:src="@{/archivos/mastercard-og-image.png}" alt="Mastercard" style="width: 40px;" class="me-2">
                                    </div>
                                </div>

                                <!-- Yape/Plin -->
                                <div class="metodo-item p-3 border rounded">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="metodoPago" id="yape" value="yape">
                                        <label class="form-check-label fw-bold" for="yape">
                                            <i class="fas fa-mobile-alt me-2 text-info"></i>
                                            Yape o Plin
                                        </label>
                                    </div>
                                    <div class="yape-info ms-4 mt-3" style="display: none;">
                                        <div class="alert alert-info">
                                            <strong>Instrucciones:</strong><br>
                                            1. Abre Yape o Plin en tu celular<br>
                                            2. Escanea el código QR que aparecerá<br>
                                            3. Confirma el pago de <strong id="montoYape">S/ <span th:text="${#numbers.formatDecimal(total, 1, 2)}">0.00</span></strong>
                                        </div>
                                    </div>
                                    <p class="text-muted ms-4 mb-0 mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Paga con tu app de billetera digital de forma rápida y segura.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha - Resumen -->
                    <div class="col-lg-4">
                        <!-- Resumen del pedido -->
                        <div class="resumen-pedido card mb-4 sticky-top" style="top: 20px;">
                            <div class="card-header bg-orange text-white">
                                <h4 class="mb-0">
                                    <i class="fas fa-receipt me-2"></i>
                                    RESUMEN DE TU PEDIDO
                                    </h5>
                            </div>
                            <div class="card-body">
                                <!-- Productos -->
                                <div class="productos-lista mb-3" id="productosLista">
                                    <div th:if="${!#lists.isEmpty(carrito)}">
                                        <div class="producto-resumen d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom"
                                             th:each="item : ${carrito}">
                                            <div class="producto-info">
                                                <div class="fw-bold" th:text="${item.producto.nombre}">Producto</div>
                                                <small class="text-muted" th:text="'Cantidad: ' + ${item.cantidad}">Cantidad: 1</small>
                                            </div>
                                            <div class="producto-precio fw-bold text-success">
                                                S/ <span th:text="${#numbers.formatDecimal(item.precioUnitario * item.cantidad, 1, 2)}">0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:if="${#lists.isEmpty(carrito)}" class="text-center py-3">
                                        <i class="fas fa-shopping-cart text-muted me-2"></i>No hay productos en el carrito
                                    </div>
                                </div>

                                <!-- Desglose de costos -->
                                <div class="costos-desglose mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Subtotal:</span>
                                        <span id="subtotal">S/ <span th:text="${#numbers.formatDecimal(subtotal, 1, 2)}">0.00</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Delivery:</span>
                                        <span id="delivery" th:class="${costoEnvio == 0} ? 'text-success' : ''">
                                            <th:block th:if="${costoEnvio == 0}">
                                                <span>GRATIS</span>
                                            </th:block>
                                            <th:block th:if="${costoEnvio > 0}">
                                                S/ <span th:text="${#numbers.formatDecimal(costoEnvio, 1, 2)}">0.00</span>
                                            </th:block>
                                        </span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2" th:if="${descuento > 0}">
                                        <span class="text-muted">Descuento:</span>
                                        <span id="descuento" class="text-success">-S/ <span th:text="${#numbers.formatDecimal(descuento, 1, 2)}">0.00</span></span>
                                    </div>
                                </div>

                                <hr>

                                <!-- Total -->
                                <div class="resumen-total d-flex justify-content-between align-items-center">
                                    <span class="fw-bold fs-5">TOTAL A PAGAR</span>
                                    <span class="fw-bold fs-5 text-orange" id="totalPagar">
                                        S/ <span th:text="${#numbers.formatDecimal(total, 1, 2)}">0.00</span>
                                    </span>
                                </div>

                                <!-- Tiempo estimado -->
                                <div class="tiempo-entrega text-center mt-3 p-3 bg-light rounded">
                                    <i class="fas fa-clock text-orange me-2"></i>
                                    <strong>Tiempo estimado:</strong>
                                    <span class="text-muted">30-45 minutos</span>
                                </div>
                            </div>
                        </div>

                        <!-- Garantías -->
                        <div class="garantias card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                    <h6 class="fw-bold">Compra 100% Segura</h6>
                                </div>
                                <div class="mb-3">
                                    <i class="fas fa-truck fa-2x text-primary mb-2"></i>
                                    <h6 class="fw-bold">Entrega en 30-45 min</h6>
                                </div>
                                <div>
                                    <i class="fas fa-undo fa-2x text-warning mb-2"></i>
                                    <h6 class="fw-bold">Devolución Garantizada</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón de confirmar pedido -->
                <div class="confirmar-pedido text-center mt-4">
                    <button class="btn btn-confirmar btn-lg w-100 py-3" id="btnConfirmarPedido"
                            th:disabled="${#lists.isEmpty(carrito)}">
                        <i class="fas fa-check-circle me-2"></i>
                        <span th:if="${!#lists.isEmpty(carrito)}">
                            CONFIRMAR Y PAGAR PEDIDO - S/ <span th:text="${#numbers.formatDecimal(total, 1, 2)}">0.00</span>
                        </span>
                        <span th:if="${#lists.isEmpty(carrito)}">
                            CARRITO VACÍO
                        </span>
                    </button>
                    <p class="text-muted mt-2 small">
                        <i class="fas fa-lock me-1"></i>
                        Tus datos están protegidos. Al confirmar tu pedido, aceptas nuestros
                        <a th:href="@{/terminos}" class="text-orange">términos y condiciones</a> y
                        <a th:href="@{/politica-datos}" class="text-orange">política de privacidad</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!--  FORMULARIO OCULTO PARA CONFIRMAR PEDIDO -->
    <form id="pedidoForm" th:action="@{/pedido/crear}" method="post" style="display: none;">
        <input type="hidden" id="formDatosPedido" name="datosPedido">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>
</main>

<!--fragment footer-->
<div th:insert="~{/fragments/footer.html :: footer}"></div>
<!--FIN fragment footer-->

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>



<script th:src="@{/script/pago.js}"></script>
</body>
</html>